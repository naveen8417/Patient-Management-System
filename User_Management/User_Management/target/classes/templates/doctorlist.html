<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Doctor Appointments</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
	<style>
		body {
			background-color: #f0f8ff;
			position: relative;
			/* Ensure positioning context for absolute positioning */
		}

		.container {
			margin-top: 50px;
		}

		h2 {
			color: #007bff;
			text-align: center;
			margin-bottom: 30px;
		}

		table {
			width: 100%;
			border-collapse: collapse;
			margin-bottom: 20px;
		}

		th,
		td {
			border: 1px solid #dee2e6;
			padding: 8px;
			text-align: left;
		}

		th {
			background-color: #007bff;
			color: white;
		}

		tr:nth-child(even) {
			background-color: #f2f2f2;
		}

		.back-button {
			position: absolute;
			top: 10px;
			left: 10px;
			z-index: 999;
			/* Ensure visibility above other elements */
		}

		.text-center {
			margin-top: 140px;
		}
	</style>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>

<body>
	<div class="container">
		<!-- Back button -->
		<button class="btn btn-primary back-button" onclick="goBack()">Back</button>

		<h2>Doctor Appointments</h2>
		<!-- Search form -->
		<form class="form-inline mb-3" id="searchForm">
			<input type="text" class="form-control mr-sm-2" id="searchInput" placeholder="Search">
			<button type="button" class="btn btn-primary" onclick="search()">Search</button>
			<!-- Change type to button and add onclick event -->
		</form>
		<!-- Appointments table -->
		<table class="table">
			<thead>
				<tr>
					<th>Appointment ID</th>
					<th>DOCTOR ID </th>
					<th>DOCTOR Name</th>
					<th>Patient ID</th>
					<th>Patient Name</th>
					<th>Date</th>
					<th>TIME</th>
					<th>Approval</th>
					<th>Delete</th>
				</tr>
			</thead>
			<tbody id="appointmentTableBody">
				<!-- Rows will be dynamically added here -->
			</tbody>
		</table>
		<!-- Pagination -->
		<nav aria-label="Page navigation example">
			<ul class="pagination justify-content-center" id="pagination"></ul>
		</nav>
		<!-- Delete all appointments button with confirmation -->
		<button class="btn btn-danger" onclick="confirmDeleteAllAppointments()">Delete All Appointments</button>
	</div>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script>
		// Function to go back
		function goBack() {
			window.history.back();
		}

		// Rest of the JavaScript code remains unchanged...

		$(document).ready(function () {
			// Fetch doctor appointments from backend API
			fetchAppointments();

			// Search form submission
			$('#searchForm').submit(function (event) {
				event.preventDefault();
				const searchTerm = $('#searchInput').val().trim();
				if (searchTerm !== '') {
					searchAppointments(searchTerm);
				} else {
					fetchAppointments();
				}
			});
		});

		// Function to fetch doctor appointments
		function fetchAppointments() {
			$.ajax({
				url: '/user/getDoctorAppointments', // Endpoint to fetch doctor appointments
				method: 'GET',
				success: function (data) {
					populateAppointmentsTable(data);
				},
				error: function (xhr, status, error) {
					console.error('Error fetching appointments:', error);
				}
			});
		}

		// Function to populate appointments table
		function populateAppointmentsTable(data) {
			$('#appointmentTableBody').empty(); // Clear existing rows
			data.forEach(appointment => {
				const row = `
            <tr>
                <td>${appointment.appointmentid}</td>
                <td>${appointment.doctorid}</td>
                <td>${appointment.doctorName}</td>
                <td>${appointment.id}</td>
                <td>${appointment.patientName}</td>
                <td>${appointment.date}</td>
                <td>${appointment.slot}</td>
                <td>
                    <select class="form-control status-dropdown" onchange="changeStatus(${appointment.appointmentid}, this.value)">
                        <option value="Waiting" ${appointment.status === 'Waiting' ? 'selected' : ''}>Waiting for Approval</option>
                        <option value="Approved" ${appointment.status === 'Approved' ? 'selected' : ''}>Approve</option>
                        <option value="Rejected" ${appointment.status === 'Rejected' ? 'selected' : ''}>Reject</option>
                    </select>
                </td>
                 <td>
                    <button class="btn btn-danger btn-sm" onclick="deleteAppointment(${appointment.appointmentid})">Delete</button>
                </td>
            </tr>
        `;
				$('#appointmentTableBody').append(row);
			});

			// Add pagination after populating the table
			addPagination(data.length);
		}

		// Function to add pagination
		function addPagination(totalItems) {
			const itemsPerPage = 5;
			const totalPages = Math.ceil(totalItems / itemsPerPage);
			const pagination = $('#pagination');
			pagination.empty(); // Clear existing pagination

			for (let i = 1; i <= totalPages; i++) {
				const li = $('<li class="page-item"><a class="page-link" href="#" onclick="paginate(' + i + ')">' + i + '</a></li>');
				pagination.append(li);
			}
		}

		// Function to handle pagination
		function paginate(page) {
			const itemsPerPage = 5;
			const startIndex = (page - 1) * itemsPerPage;
			const endIndex = startIndex + itemsPerPage;
			const rows = $('#appointmentTableBody tr');

			rows.hide(); // Hide all rows
			rows.slice(startIndex, endIndex).show(); // Show rows for the selected page
		}

		// Function to search appointments
		function search() {
			var searchText = $('#searchInput').val().trim().toLowerCase(); // Get the search input value and convert to lowercase
			var rows = $('#appointmentTableBody tr'); // Get all table rows
			rows.each(function () {
				var text = $(this).text().toLowerCase(); // Get the text content of the row and convert to lowercase
				if (text.includes(searchText)) {
					$(this).show(); // Show the row if it contains the search text
				} else {
					$(this).hide(); // Hide the row if it does not contain the search text
				}
			});
		}

		// Function to change the status of an appointment
		function changeStatus(appointmentid, status) {
			// Store the updated status in the browser's sessionStorage
			sessionStorage.setItem(`appointment_${appointmentid}_status`, status);

			$.ajax({
				url: '/user/updateAppointmentStatus', // Endpoint to update appointment status
				method: 'POST',
				data: {appointmentid: appointmentid, status: status},
				success: function (response) {
					console.log(response);
				},
				error: function (xhr, status, error) {
					console.error('Error updating appointment status:', error);
				}
			});
		}

		// Function to confirm deletion of all appointments
		

		// Function to delete all appointments
		// Function to delete all appointments
		// Function to delete all appointments
function confirmDeleteAllAppointments() {
    // Display SweetAlert confirmation dialog
    Swal.fire({
        title: 'Are you sure?',
        text: "This action cannot be undone!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, delete all appointments!'
    }).then((result) => {
        if (result.isConfirmed) {
            // If user confirms, send AJAX request to delete all appointments
            $.ajax({
                url: 'http://localhost:8888/user/deleteAll', // Endpoint to delete all appointments
                method: 'DELETE',
                success: function(response) {
                    // Show success message with SweetAlert
                    Swal.fire(
                        'Deleted!',
                        'All appointments have been deleted.',
                        'success'
                    ).then(() => {
                        // Refresh the appointments table after deletion
                        fetchAppointments();
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error deleting appointments:', error);
                    // Show error message with SweetAlert
                    Swal.fire(
                        'Error!',
                        'An error occurred while deleting appointments.',
                        'error'
                    );
                }
            });
        }
    });
}


		// Function to delete an appointment
		// Function to delete an appointment
		// Function to delete an appointment by ID
		// Function to delete an appointment
		function deleteAppointment(appointmentId) {
			// Display SweetAlert confirmation dialog
			Swal.fire({
				title: "Are you sure?",
				text: "You won't be able to revert this!",
				icon: "warning",
				showCancelButton: true,
				confirmButtonColor: "#3085d6",
				cancelButtonColor: "#d33",
				confirmButtonText: "Yes, delete it!"
			}).then((result) => {
				if (result.isConfirmed) {
					// If confirmed, send AJAX request to delete appointment
					$.ajax({
						url: 'http://localhost:8888/user/delete', // Endpoint to delete an appointment
						method: 'GET', // Use GET method
						data: {appointmentid: appointmentId}, // Send appointment ID as data
						success: function (response) {
							// Show success message with SweetAlert
							Swal.fire(
								'Deleted!',
								'Your appointment has been deleted.',
								'success'
							);
							// Refresh the appointments table after deletion
							fetchAppointments();
						},
						error: function (xhr, status, error) {
							console.error('Error deleting appointment:', error);
							// Show error message with SweetAlert
							Swal.fire(
								'Error!',
								'An error occurred while deleting the appointment.',
								'error'
							);
						}
					});
				}
			});
		}



	</script>
</body>

</html>